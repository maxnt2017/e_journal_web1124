<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ультимативний Електронний Журнал</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
</head>
<body>
    <div class="journal-container">
        <header class="header-controls">
            <h1>Електронний журнал</h1>
            <div class="theme-switcher">
                <i class="fas fa-sun"></i>
                <label class="switch">
                    <input type="checkbox" id="themeToggle">
                    <span class="slider"></span>
                </label>
                <i class="fas fa-moon"></i>
            </div>
        </header>

        <main>
            <div class="management-panel">
                <div class="input-group">
                    <label for="groupSelector">Вибрана група:</label>
                    <select id="groupSelector"></select>
                </div>
                <div class="input-group">
                    <label for="newGroupName">Створити нову групу:</label>
                    <input type="text" id="newGroupName" placeholder="Назва групи">
                </div>
                <button id="addGroupBtn"><i class="fas fa-plus icon"></i>Створити</button>
                <button id="deleteGroupBtn"><i class="fas fa-trash-alt icon"></i>Видалити поточну</button>
            </div>
            
            <div class="management-panel">
                 <form id="addStudentForm" class="add-form">
                    <div class="input-group"><label>Новий студент:</label><input type="text" id="studentName" placeholder="Ім'я студента" required></div>
                    <div class="input-group"><label>Предмет:</label><input type="text" id="subject" placeholder="Основний предмет" required></div>
                    <button type="submit"><i class="fas fa-user-plus icon"></i>Додати студента</button>
                </form>
                <div class="input-group">
                    <label>Пошук:</label>
                    <input type="text" id="searchInput" class="search-input" placeholder="Пошук за іменем...">
                </div>
                <button id="printReportBtn"><i class="fas fa-print icon"></i>Друкувати звіт</button>
            </div>

            <div class="stats-container">
                <strong>Середня оцінка в групі:</strong> <span id="averageGrade">N/A</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th data-sort="name">Ім'я студента ▾</th>
                        <th data-sort="subject">Предмет ▾</th>
                        <th data-sort="average">Середня оцінка ▾</th>
                        <th>Дії</th>
                    </tr>
                </thead>
                <tbody id="journalBody"></tbody>
            </table>

            <div class="main-actions">
                 <button id="backupBtn"><i class="fas fa-download icon"></i>Зберегти Бекап</button>
                 <button id="restoreBtn"><i class="fas fa-upload icon"></i>Завантажити Бекап</button>
                 <input type="file" id="restoreFile" style="display: none;" accept=".json">
                 <button id="clearAllBtn"><i class="fas fa-bomb icon"></i>Очистити групу</button>
            </div>

            <div class="chart-container">
                <h2>Розподіл середніх оцінок</h2>
                <canvas id="gradesChart"></canvas>
            </div>
        </main>
    </div>

    <div id="studentDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="studentNameModal"></h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="student-details-grid">
                <div class="grades-section">
                    <h3>Оцінки з предмету: <span id="subjectNameModal"></span></h3>
                    <ul class="grades-list" id="gradesList"></ul>
                    <form id="addGradeForm" class="add-grade-form">
                        <input type="number" id="newGradeValue" min="1" max="12" placeholder="Оцінка" required>
                        <input type="text" id="newGradeComment" placeholder="Коментар (напр. Контрольна)">
                        <button type="submit"><i class="fas fa-plus"></i></button>
                    </form>
                </div>
                <div class="modal-charts">
                    <div class="chart-container">
                        <h4>Динаміка успішності</h4>
                        <canvas id="studentProgressChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Відвідуваність</h4>
                        <canvas id="attendanceDonutChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    
    <footer>
        <p>Copyright 2017-2025(c), MaxNT Official. Всі права захищені!</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    // --- ГЛОБАЛЬНІ ЗМІННІ ТА ЕЛЕМЕНТИ DOM ---
    let journalData = {}; let activeGroup = ''; let activeStudentId = null;
    let gradesChart = null; let studentProgressChart = null; let attendanceDonutChart = null;
    
    const groupSelector = document.getElementById('groupSelector');
    const addGroupBtn = document.getElementById('addGroupBtn');
    const newGroupNameInput = document.getElementById('newGroupName');
    const deleteGroupBtn = document.getElementById('deleteGroupBtn');
    const tableBody = document.getElementById('journalBody');
    const addStudentForm = document.getElementById('addStudentForm');
    const searchInput = document.getElementById('searchInput');
    const averageGradeEl = document.getElementById('averageGrade');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const backupBtn = document.getElementById('backupBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const restoreFileInput = document.getElementById('restoreFile');
    const themeToggle = document.getElementById('themeToggle');
    const printReportBtn = document.getElementById('printReportBtn');
    
    // Модальне вікно
    const studentModal = document.getElementById('studentDetailModal');
    const studentNameModalEl = document.getElementById('studentNameModal');
    const subjectNameModalEl = document.getElementById('subjectNameModal');
    const gradesListEl = document.getElementById('gradesList');
    const addGradeForm = document.getElementById('addGradeForm');

    // --- СИСТЕМА СПОВІЩЕНЬ ---
    const showToast = (message, type = 'success') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    };

    // --- КЕРУВАННЯ ТЕМОЮ ---
    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.checked = true;
        } else {
            document.body.classList.remove('dark-mode');
            themeToggle.checked = false;
        }
    };
    themeToggle.addEventListener('change', () => {
        const theme = themeToggle.checked ? 'dark' : 'light';
        localStorage.setItem('journalTheme', theme);
        applyTheme(theme);
    });

    // --- ОСНОВНІ ФУНКЦІЇ ---
    const loadData = () => {
        const data = JSON.parse(localStorage.getItem('journalData'));
        journalData = (data && Object.keys(data).length > 0) ? data : { 'Стандартна група': [] };
        activeGroup = localStorage.getItem('activeGroup') || Object.keys(journalData)[0];
        const savedTheme = localStorage.getItem('journalTheme') || 'light';
        applyTheme(savedTheme);
    };
    const saveData = () => {
        localStorage.setItem('journalData', JSON.stringify(journalData));
        localStorage.setItem('activeGroup', activeGroup);
    };
    const calculateAverage = (grades) => {
        if (!grades || grades.length === 0) return 'N/A';
        const total = grades.reduce((sum, grade) => sum + grade.value, 0);
        return (total / grades.length).toFixed(2);
    };

    // --- РЕНДЕРИНГ ІНТЕРФЕЙСУ ---
    const rerenderUI = () => {
        renderGroupSelector();
        const students = journalData[activeGroup] || [];
        renderTable(students);
        updateGroupStats();
        renderGradeChart();
        searchInput.value = '';
    };

    const renderGroupSelector = () => {
        groupSelector.innerHTML = '';
        Object.keys(journalData).forEach(groupName => {
            const option = new Option(groupName, groupName, false, groupName === activeGroup);
            groupSelector.add(option);
        });
    };

    const renderTable = (students) => {
        tableBody.innerHTML = '';
        if (!students || students.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">У цій групі ще немає студентів.</td></tr>';
            return;
        }
        students.forEach(s => {
            const average = parseFloat(calculateAverage(s.grades));
            const row = document.createElement('tr');
            let gradeClass = 'grade-na';
            if (!isNaN(average)) {
                if (average >= 10) gradeClass = 'grade-high';
                else if (average >= 7) gradeClass = 'grade-mid';
                else gradeClass = 'grade-low';
            }
            row.innerHTML = `
                <td><span class="student-name" data-id="${s.id}">${s.name}</span></td>
                <td>${s.subject}</td>
                <td><span class="grade-badge ${gradeClass}">${isNaN(average) ? 'N/A' : average}</span></td>
                <td class="action-buttons">
                    <button class="delete-btn" data-id="${s.id}"><i class="fas fa-user-minus"></i></button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };
    
    const updateGroupStats = () => {
        const students = journalData[activeGroup] || [];
        const validAverages = students.map(s => parseFloat(calculateAverage(s.grades))).filter(avg => !isNaN(avg));
        if (validAverages.length === 0) {
            averageGradeEl.textContent = 'N/A'; return;
        }
        const totalAverage = validAverages.reduce((sum, avg) => sum + avg, 0);
        averageGradeEl.textContent = (totalAverage / validAverages.length).toFixed(2);
    };

    const renderGradeChart = () => {
        const ctx = document.getElementById('gradesChart').getContext('2d');
        const students = journalData[activeGroup] || [];
        const gradeDistribution = { '1-3': 0, '4-6': 0, '7-9': 0, '10-12': 0, 'N/A': 0 };
        students.forEach(s => {
            const avg = parseFloat(calculateAverage(s.grades));
            if (isNaN(avg)) gradeDistribution['N/A']++;
            else if (avg <= 3) gradeDistribution['1-3']++;
            else if (avg <= 6) gradeDistribution['4-6']++;
            else if (avg <= 9) gradeDistribution['7-9']++;
            else if (avg <= 12) gradeDistribution['10-12']++;
        });
        if (gradesChart) gradesChart.destroy();
        gradesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(gradeDistribution),
                datasets: [{
                    label: 'Кількість студентів за рівнем оцінок',
                    data: Object.values(gradeDistribution),
                    backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745', '#6c757d'],
                }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    };

    // --- ЛОГІКА МОДАЛЬНОГО ВІКНА ---
    const openStudentModal = (studentId) => {
        const student = journalData[activeGroup].find(s => s.id === studentId);
        if (!student) return;
        activeStudentId = studentId;
        studentNameModalEl.textContent = student.name;
        subjectNameModalEl.textContent = student.subject;
        renderGradesList();
        studentModal.style.display = 'block';
        renderStudentProgressChart();
        renderAttendanceDonutChart();
    };
    const closeModal = () => { studentModal.style.display = 'none'; activeStudentId = null; };
    const renderGradesList = () => {
        const student = journalData[activeGroup].find(s => s.id === activeStudentId);
        gradesListEl.innerHTML = '';
        if (!student.grades || student.grades.length === 0) {
            gradesListEl.innerHTML = '<li>Оцінок ще немає.</li>'; return;
        }
        student.grades.forEach(grade => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="grade-info">
                    <strong>${grade.value}</strong> - <span class="comment">${grade.comment || 'Без коментаря'}</span>
                    <div class="comment">${new Date(grade.date).toLocaleDateString()}</div>
                </div>
                <button class="grade-delete-btn" data-grade-id="${grade.id}">&times;</button>
            `;
            gradesListEl.appendChild(li);
        });
    };
    
    // --- НОВІ ГРАФІКИ В МОДАЛЬНОМУ ВІКНІ ---
    const renderStudentProgressChart = () => {
        const ctx = document.getElementById('studentProgressChart').getContext('2d');
        const student = journalData[activeGroup].find(s => s.id === activeStudentId);
        if (studentProgressChart) studentProgressChart.destroy();
        const sortedGrades = [...student.grades].sort((a, b) => new Date(a.date) - new Date(b.date));
        studentProgressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedGrades.map(g => new Date(g.date).toLocaleDateString()),
                datasets: [{
                    label: 'Оцінки',
                    data: sortedGrades.map(g => g.value),
                    fill: false,
                    borderColor: 'var(--primary-color)',
                    tension: 0.1
                }]
            },
            options: { scales: { y: { beginAtZero: false, max: 12 } } }
        });
    };
    const renderAttendanceDonutChart = () => {
        const ctx = document.getElementById('attendanceDonutChart').getContext('2d');
        const student = journalData[activeGroup].find(s => s.id === activeStudentId);
        if (attendanceDonutChart) attendanceDonutChart.destroy();
        // Примітка: Функціонал відвідуваності не було додано в фінальну версію HTML,
        // тому цей графік буде порожнім. Якщо потрібно, його можна додати.
        const attData = { 'Присутній': 0, 'Відсутній': 0, 'Запізнився': 0 };
        if(student.attendance) {
            student.attendance.forEach(att => attData[att.status]++);
        }
        attendanceDonutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(attData),
                datasets: [{
                    data: Object.values(attData),
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                }]
            }
        });
    };
    
    // --- ОБРОБНИКИ ПОДІЙ ---
    groupSelector.addEventListener('change', () => { activeGroup = groupSelector.value; saveData(); rerenderUI(); });
    addGroupBtn.addEventListener('click', () => {
        const name = newGroupNameInput.value.trim();
        if (name && !journalData[name]) {
            journalData[name] = []; activeGroup = name; saveData(); rerenderUI(); newGroupNameInput.value = '';
            showToast(`Групу "${name}" успішно створено!`);
        } else {
            showToast('Неправильна назва або група вже існує!', 'error');
        }
    });
    deleteGroupBtn.addEventListener('click', () => {
        if (Object.keys(journalData).length <= 1) { showToast('Неможливо видалити останню групу.', 'error'); return; }
        if (confirm(`Видалити групу "${activeGroup}"? Ця дія незворотня!`)) {
            const deletedGroup = activeGroup;
            delete journalData[activeGroup]; activeGroup = Object.keys(journalData)[0]; saveData(); rerenderUI();
            showToast(`Групу "${deletedGroup}" видалено.`);
        }
    });
    addStudentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const studentName = document.getElementById('studentName').value;
        journalData[activeGroup].push({
            id: Date.now(),
            name: studentName,
            subject: document.getElementById('subject').value,
            grades: [],
            attendance: []
        });
        addStudentForm.reset(); saveData(); rerenderUI();
        showToast(`Студента ${studentName} додано.`);
    });
    tableBody.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('student-name')) {
            openStudentModal(parseInt(target.dataset.id));
        }
        if (target.closest('.delete-btn')) {
            const studentId = parseInt(target.closest('.delete-btn').dataset.id);
            if (confirm('Видалити студента?')) {
                journalData[activeGroup] = journalData[activeGroup].filter(s => s.id !== studentId);
                saveData(); rerenderUI();
                showToast('Студента видалено.');
            }
        }
    });
    studentModal.querySelector('.close-btn').addEventListener('click', closeModal);
    window.addEventListener('click', (e) => { if (e.target === studentModal) closeModal(); });
    addGradeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const student = journalData[activeGroup].find(s => s.id === activeStudentId);
        student.grades.push({
            id: Date.now(),
            value: parseInt(document.getElementById('newGradeValue').value),
            comment: document.getElementById('newGradeComment').value,
            date: new Date().toISOString()
        });
        addGradeForm.reset(); saveData(); renderGradesList(); rerenderUI(); openStudentModal(activeStudentId);
        showToast('Оцінку додано.');
    });
    gradesListEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('grade-delete-btn')) {
            const gradeId = parseInt(e.target.dataset.gradeId);
            const student = journalData[activeGroup].find(s => s.id === activeStudentId);
            student.grades = student.grades.filter(g => g.id !== gradeId);
            saveData(); renderGradesList(); rerenderUI(); openStudentModal(activeStudentId);
            showToast('Оцінку видалено.');
        }
    });
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = (journalData[activeGroup] || []).filter(s => s.name.toLowerCase().includes(term));
        renderTable(filtered);
    });
    clearAllBtn.addEventListener('click', () => {
        if (confirm(`Очистити всі дані в групі "${activeGroup}"?`)) {
            journalData[activeGroup] = []; saveData(); rerenderUI();
            showToast(`Групу "${activeGroup}" очищено.`, 'error');
        }
    });
    backupBtn.addEventListener('click', () => {
        const dataStr = JSON.stringify(journalData, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `journal_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
        showToast('Резервну копію успішно створено!');
    });
    restoreBtn.addEventListener('click', () => restoreFileInput.click());
    restoreFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const restoredData = JSON.parse(event.target.result);
                if (confirm('Завантажити дані з бекапу? Всі поточні дані будуть перезаписані!')) {
                    journalData = restoredData;
                    activeGroup = Object.keys(journalData)[0];
                    saveData(); rerenderUI();
                    showToast('Дані успішно відновлено!');
                }
            } catch (err) { showToast('Помилка: Неправильний формат файлу.', 'error'); }
        };
        reader.readAsText(file);
        e.target.value = '';
    });
    printReportBtn.addEventListener('click', () => {
        showToast('Підготовка звіту до друку...');
        setTimeout(() => window.print(), 500);
    });

    // --- ПЕРШИЙ ЗАПУСК ---
    loadData();
    rerenderUI();
});
    </script>
</body>
</html>
