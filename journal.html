<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Електронний журнал</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="journal-container">
        <header>
            <h1>Електронний журнал</h1>
        </header>

        <main>
            <div class="group-management">
                <div class="input-group">
                    <label for="groupSelector">Вибрана група:</label>
                    <select id="groupSelector"></select>
                </div>
                <div class="input-group">
                    <label for="newGroupName">Створити нову групу:</label>
                    <input type="text" id="newGroupName" placeholder="Назва нової групи">
                </div>
                <button id="addGroupBtn">Створити</button>
                <button id="deleteGroupBtn">Видалити поточну групу</button>
            </div>

            <div class="controls-container">
                <form id="addStudentForm" class="add-form">
                    <input type="text" id="studentName" placeholder="Ім'я студента" required>
                    <input type="text" id="subject" placeholder="Предмет" required>
                    <input type="number" id="grade" placeholder="Поточна оцінка" min="1" max="12" required>
                    <button type="submit">Додати запис</button>
                </form>
                <input type="text" id="searchInput" class="search-input" placeholder="Пошук за іменем...">
            </div>

            <div class="stats-container">
                <strong>Середня поточна оцінка в групі:</strong> <span id="averageGrade">N/A</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th data-sort="name">Ім'я студента ▾</th>
                        <th data-sort="subject">Предмет ▾</th>
                        <th data-sort="grade">Поточна ▾</th>
                        <th>Семестрова</th>
                        <th>Річна</th>
                        <th>Дії</th>
                    </tr>
                </thead>
                <tbody id="journalBody"></tbody>
            </table>
            <div class="main-actions">
                 <button id="exportBtn">Експорт у CSV</button>
                 <button id="clearAllBtn">Очистити групу</button>
            </div>

            <div class="chart-container">
                <h2>Розподіл оцінок у групі</h2>
                <canvas id="gradesChart"></canvas>
            </div>
        </main>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Редагувати запис</h2>
            <form id="editForm">
                <input type="hidden" id="editStudentId">
                <div class="input-group">
                    <label for="editStudentName">Ім'я студента</label>
                    <input type="text" id="editStudentName" required>
                </div>
                <div class="input-group">
                    <label for="editSubject">Предмет</label>
                    <input type="text" id="editSubject" required>
                </div>
                <div class="input-group">
                    <label for="editGrade">Поточна оцінка</label>
                    <input type="number" id="editGrade" min="1" max="12" required>
                </div>
                <button type="submit">Зберегти зміни</button>
            </form>
        </div>
    </div>
    
    <footer>
        <p>Copyright 2017-2025(c), MaxNT Official. Всі права захищені!</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ГЛОБАЛЬНІ ЗМІННІ ТА ЕЛЕМЕНТИ DOM ---
            const groupSelector = document.getElementById('groupSelector');
            const addGroupBtn = document.getElementById('addGroupBtn');
            const newGroupNameInput = document.getElementById('newGroupName');
            const deleteGroupBtn = document.getElementById('deleteGroupBtn');
            const tableBody = document.getElementById('journalBody');
            const addStudentForm = document.getElementById('addStudentForm');
            const searchInput = document.getElementById('searchInput');
            const averageGradeEl = document.getElementById('averageGrade');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const exportBtn = document.getElementById('exportBtn');
            const modal = document.getElementById('editModal');
            const closeBtn = document.querySelector('.close-btn');
            const editForm = document.getElementById('editForm');
            
            let journalData = {};
            let activeGroup = '';
            let gradesChart = null; // Змінна для зберігання об'єкта графіка
            
            // --- ОСНОВНІ ФУНКЦІЇ ---

            // Завантаження даних
            const loadData = () => {
                const data = JSON.parse(localStorage.getItem('journalData'));
                if (data && Object.keys(data).length > 0) {
                    journalData = data;
                } else {
                    journalData = { 'Стандартна група': [] }; // Створюємо першу групу
                }
                activeGroup = localStorage.getItem('activeGroup') || Object.keys(journalData)[0];
            };

            // Збереження даних
            const saveData = () => {
                localStorage.setItem('journalData', JSON.stringify(journalData));
                localStorage.setItem('activeGroup', activeGroup);
            };

            // Перерендер всіх елементів UI
            const rerenderUI = () => {
                renderGroupSelector();
                const currentStudents = journalData[activeGroup] || [];
                renderTable(currentStudents);
                calculateStats();
                renderGradeChart();
                searchInput.value = ''; // Скидаємо пошук при зміні групи
            };

            // --- КЕРУВАННЯ ГРУПАМИ ---

            const renderGroupSelector = () => {
                groupSelector.innerHTML = '';
                for (const groupName in journalData) {
                    const option = document.createElement('option');
                    option.value = groupName;
                    option.textContent = groupName;
                    if (groupName === activeGroup) {
                        option.selected = true;
                    }
                    groupSelector.appendChild(option);
                }
            };
            
            groupSelector.addEventListener('change', () => {
                activeGroup = groupSelector.value;
                saveData();
                rerenderUI();
            });

            addGroupBtn.addEventListener('click', () => {
                const newGroupName = newGroupNameInput.value.trim();
                if (newGroupName && !journalData[newGroupName]) {
                    journalData[newGroupName] = [];
                    activeGroup = newGroupName;
                    saveData();
                    rerenderUI();
                    newGroupNameInput.value = '';
                } else {
                    alert('Група з такою назвою вже існує або назва порожня!');
                }
            });

            deleteGroupBtn.addEventListener('click', () => {
                if (Object.keys(journalData).length <= 1) {
                    alert('Неможливо видалити останню групу.');
                    return;
                }
                if (confirm(`Ви впевнені, що хочете видалити групу "${activeGroup}" та всі її дані?`)) {
                    delete journalData[activeGroup];
                    activeGroup = Object.keys(journalData)[0];
                    saveData();
                    rerenderUI();
                }
            });
            
            // --- РЕНДЕР ТАБЛИЦІ ТА СТАТИСТИКИ ---

            const renderTable = (data) => {
                // ... (код renderTable з попередньої версії залишається тут без змін)
                 tableBody.innerHTML = '';
                if (!data || data.length === 0) {
                     tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">У цій групі ще немає записів.</td></tr>';
                     return;
                }
                data.forEach(student => {
                    const row = document.createElement('tr');
                    let semesterGradeHTML = student.semesterGrade ? `${student.semesterGrade} <button class="remove-grade-btn" data-id="${student.id}" data-type="semester">Видалити</button>` : `<button class="set-grade-btn" data-id="${student.id}" data-type="semester">Поставити</button>`;
                    let annualGradeHTML = student.annualGrade ? `${student.annualGrade} <button class="remove-grade-btn" data-id="${student.id}" data-type="annual">Видалити</button>` : `<button class="set-grade-btn" data-id="${student.id}" data-type="annual">Поставити</button>`;
                    row.innerHTML = `<td>${student.name}</td><td>${student.subject}</td><td>${student.grade}</td><td class="grade-actions">${semesterGradeHTML}</td><td class="grade-actions">${annualGradeHTML}</td><td class="action-buttons"><button class="edit-btn" data-id="${student.id}">Редагувати</button><button class="delete-btn" data-id="${student.id}">Видалити</button></td>`;
                    tableBody.appendChild(row);
                });
            };

            const calculateStats = () => {
                const students = journalData[activeGroup] || [];
                if (students.length === 0) {
                    averageGradeEl.textContent = 'N/A';
                    return;
                }
                const totalGrade = students.reduce((sum, student) => sum + student.grade, 0);
                averageGradeEl.textContent = (totalGrade / students.length).toFixed(2);
            };

            // --- РЕНДЕР ГРАФІКА ---

            const renderGradeChart = () => {
                const ctx = document.getElementById('gradesChart').getContext('2d');
                const students = journalData[activeGroup] || [];
                
                const gradeCounts = Array(12).fill(0); // Масив для оцінок від 1 до 12
                students.forEach(s => {
                    if (s.grade >= 1 && s.grade <= 12) {
                        gradeCounts[s.grade - 1]++;
                    }
                });

                if (gradesChart) {
                    gradesChart.destroy(); // Знищуємо попередній графік
                }
                
                gradesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                        datasets: [{
                            label: 'Кількість студентів',
                            data: gradeCounts,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1 // Крок осі Y - цілі числа
                                }
                            }
                        }
                    }
                });
            };

            // --- ЕКСПОРТ У CSV ---

            exportBtn.addEventListener('click', () => {
                const students = journalData[activeGroup] || [];
                if (students.length === 0) {
                    alert('Немає даних для експорту.');
                    return;
                }
                const headers = ['Ім\'я студента', 'Предмет', 'Поточна', 'Семестрова', 'Річна'];
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n';
                
                students.forEach(s => {
                    const row = [s.name, s.subject, s.grade, s.semesterGrade || '', s.annualGrade || ''];
                    csvContent += row.join(',') + '\n';
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${activeGroup}_export.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // --- ІНШІ ОБРОБНИКИ ПОДІЙ ---
            
            // ... (обробники для модального вікна, додавання, видалення, редагування, сортування, очищення групи - код майже такий самий, але тепер працює з `journalData[activeGroup]`)

            // Початковий запуск
            loadData();
            rerenderUI();
        });
    </script>
</body>
</html>
