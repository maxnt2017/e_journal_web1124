<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ультимативний Електронний Журнал</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
</head>
<body>
    <div class="journal-container">
        <header class="header-controls">
            <h1>Електронний журнал</h1>
            <div class="theme-switcher">
                <i class="fas fa-sun"></i>
                <label class="switch">
                    <input type="checkbox" id="themeToggle">
                    <span class="slider"></span>
                </label>
                <i class="fas fa-moon"></i>
            </div>
        </header>

        <main>
            <div class="management-panel">
                 <button id="printReportBtn"><i class="fas fa-print icon"></i>Друкувати звіт</button>
            </div>
            
            <table>
                <thead><tr><th data-sort="name">Ім'я студента ▾</th><th data-sort="subject">Предмет ▾</th><th data-sort="average">Середня оцінка ▾</th><th>Дії</th></tr></thead>
                <tbody id="journalBody"></tbody>
            </table>

            </main>
    </div>

    <div id="studentDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="studentNameModal"></h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="student-details-grid">
                <div class="grades-section">
                    <h3>Оцінки з предмету: <span id="subjectNameModal"></span></h3>
                    <ul class="grades-list" id="gradesList"></ul>
                    <form id="addGradeForm" class="add-grade-form">
                        </form>
                </div>
                <div class="modal-charts">
                    <div class="chart-container">
                        <h4>Динаміка успішності</h4>
                        <canvas id="studentProgressChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Відвідуваність</h4>
                        <canvas id="attendanceDonutChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    
    <script>
   document.addEventListener('DOMContentLoaded', () => {
    // --- ГЛОБАЛЬНІ ЗМІННІ ТА ЕЛЕМЕНТИ DOM ---
    let journalData = {}; let activeGroup = ''; let activeStudentId = null;
    let gradesChart = null; let studentProgressChart = null; let attendanceDonutChart = null;
    
    // ... (всі getElementById з попередньої версії) ...
    const themeToggle = document.getElementById('themeToggle');
    const printReportBtn = document.getElementById('printReportBtn');

    // --- СИСТЕМА СПОВІЩЕНЬ ---
    const showToast = (message, type = 'success') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    };

    // --- КЕРУВАННЯ ТЕМОЮ ---
    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.checked = true;
        } else {
            document.body.classList.remove('dark-mode');
            themeToggle.checked = false;
        }
    };
    themeToggle.addEventListener('change', () => {
        const theme = themeToggle.checked ? 'dark' : 'light';
        localStorage.setItem('journalTheme', theme);
        applyTheme(theme);
    });

    // --- ОСНОВНІ ФУНКЦІЇ ---
    const loadData = () => {
        // ... (код завантаження даних без змін) ...
        const savedTheme = localStorage.getItem('journalTheme') || 'light';
        applyTheme(savedTheme);
    };
    // ... (saveData, calculateAverage - без змін) ...

    // --- РЕНДЕРИНГ ІНТЕРФЕЙСУ ---
    const rerenderUI = () => { /* ... (без змін) ... */ };
    const renderTable = (students) => {
        tableBody.innerHTML = '';
        if (!students || students.length === 0) { /* ... */ return; }
        students.forEach(s => {
            const average = parseFloat(calculateAverage(s.grades));
            const row = document.createElement('tr');
            let gradeClass = 'grade-na';
            if (!isNaN(average)) {
                if (average >= 10) gradeClass = 'grade-high';
                else if (average >= 7) gradeClass = 'grade-mid';
                else gradeClass = 'grade-low';
            }
            row.innerHTML = `
                <td><span class="student-name" data-id="${s.id}">${s.name}</span></td>
                <td>${s.subject}</td>
                <td><span class="grade-badge ${gradeClass}">${isNaN(average) ? 'N/A' : average}</span></td>
                <td class="action-buttons">
                    <button class="delete-btn" data-id="${s.id}"><i class="fas fa-user-minus"></i></button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };
    // ... (updateGroupStats, renderGroupSelector - без змін) ...

    // --- ЛОГІКА МОДАЛЬНОГО ВІКНА ---
    const openStudentModal = (studentId) => {
        // ... (код відкриття модального вікна) ...
        renderStudentProgressChart();
        renderAttendanceDonutChart();
    };
    // ... (closeModal, renderGradesList, renderAttendanceLog - без змін) ...

    // --- НОВІ ГРАФІКИ В МОДАЛЬНОМУ ВІКНІ ---
    const renderStudentProgressChart = () => {
        const ctx = document.getElementById('studentProgressChart').getContext('2d');
        const student = journalData[activeGroup].find(s => s.id === activeStudentId);
        if (studentProgressChart) studentProgressChart.destroy();
        
        const sortedGrades = [...student.grades].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        studentProgressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedGrades.map(g => new Date(g.date).toLocaleDateString()),
                datasets: [{
                    label: 'Оцінки',
                    data: sortedGrades.map(g => g.value),
                    fill: false,
                    borderColor: 'var(--primary-color)',
                    tension: 0.1
                }]
            },
            options: { scales: { y: { beginAtZero: false, max: 12 } } }
        });
    };

    const renderAttendanceDonutChart = () => {
        const ctx = document.getElementById('attendanceDonutChart').getContext('2d');
        const student = journalData[activeGroup].find(s => s.id === activeStudentId);
        if (attendanceDonutChart) attendanceDonutChart.destroy();

        const attData = { 'Присутній': 0, 'Відсутній': 0, 'Запізнився': 0 };
        student.attendance.forEach(att => attData[att.status]++);

        attendanceDonutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(attData),
                datasets: [{
                    data: Object.values(attData),
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                }]
            }
        });
    };
    
    // --- ОБРОБНИКИ ПОДІЙ ---
    // ... (всі попередні обробники подій, але замість alert() використовуємо showToast())
    // Приклад заміни:
    // Замість: alert('Група з такою назвою вже існує!');
    // Робимо: showToast('Група з такою назвою вже існує!', 'error');

    // Друк
    printReportBtn.addEventListener('click', () => {
        showToast('Підготовка звіту до друку...');
        setTimeout(() => window.print(), 500);
    });

    // Резервне копіювання (з новими сповіщеннями)
    backupBtn.addEventListener('click', () => {
        // ... (код для бекапу) ...
        showToast('Резервну копію успішно створено!');
    });
    restoreFileInput.addEventListener('change', (e) => {
        // ... (код відновлення) ...
        // В блоці try: showToast('Дані успішно відновлено!');
        // В блоці catch: showToast('Помилка: Неправильний формат файлу.', 'error');
    });

    // --- ПЕРШИЙ ЗАПУСК ---
    loadData();
    rerenderUI();
});
    </script>
</body>
</html>
